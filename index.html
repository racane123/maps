<!DOCTYPE html>
<html>
  <head>
    <title>Mapbox Example with Custom Geolocation Button</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css">
  </head>
  <style>
    
  #map {
    height: 90vh;
  }
  #geolocateButton {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1;
    font-family: "Roboto", sans-serif;
    font-weight: 500;
    font-style: normal;
    cursor: pointer;
    color: #e5e5e5;
    text-decoration: none;
    padding: 10px;
    border-radius: 10px;
    border: solid 1px #000000;
    background-color: #14213d;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }
  </style>
  <body>
    <div id="geolocateButton">Locate Me</div>
    <div id="map"></div>
    <table id="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Name</th>
          <th>Address</th>
          <th>Action</th>
          <!-- Add more headers as needed based on your API response -->
        </tr>
      </thead>
      <tbody>
        <!-- Data rows will be added dynamically -->
      </tbody>
    </table>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1Ijoia3Jha2VuMTIzIiwiYSI6ImNsdHU1M3V3ajFhZjUya21vcGMwNG9ldDQifQ.B5h0r_S1blXJS0mJMgwYIA";
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [120.96788000, 14.64953000],
        attributionControl: false,
        zoom: 9,
      });
      map.addControl(new mapboxgl.NavigationControl(), "top-right");
      // Add geolocation control
      var geolocate = new mapboxgl.GeolocateControl({
        positionOptions: {
          enableHighAccuracy: true,
        },
        trackUserLocation: true,
      });
      map.addControl(geolocate);

      // Keep track of the popup
      var popup;

      // Add event listener to custom geolocation button
      var geolocateButton = document.getElementById("geolocateButton");
      geolocateButton.addEventListener("click", function () {
        geolocate.trigger();
      });

      // Add GeoJSON source for selected polygon or point
      map.on("style.load", function () {
        map.addSource("selected-feature", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: [], // Empty features array initially
          },
        });

        // Add a layer for polygons
        map.addLayer({
          id: "selected-polygon-layer",
          type: "fill",
          source: "selected-feature",
          paint: {
            "fill-color": "#088",
            "fill-opacity": 0.5,
          },
          filter: ["==", "$type", "Polygon"], // Only render polygons
        });

        // Add a layer for points
        map.addLayer({
          id: "selected-point-layer",
          type: "circle",
          source: "selected-feature",
          paint: {
            "circle-color": "#f00",
            "circle-radius": 6,
            "circle-opacity": 0.8,
          },
          filter: ["==", "$type", "Point"], // Only render points
        });
      });

      fetch("http://localhost/map-box-drawingboundary/api/getapi.php")
        .then((response) => response.json())
        .then((jsonData) => {
          const tableBody = document.querySelector("#data-table tbody");
          jsonData.features.forEach((feature) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${feature.properties.id}</td>
                    <td>${feature.properties.title}</td>
                    <td>${feature.properties.name}</td>  
                    <td>${feature.properties.address}</td>
                    <td>${
                      feature.geometry.type === "Polygon"
                        ? '<button class="viewButton" onclick="viewPolygon(' +
                          JSON.stringify(feature.geometry.coordinates) +
                          ', \'' + feature.properties.title + '\')">View Polygon</button>'
                        : feature.geometry.type === "Point"
                        ? '<button class="viewButton" onclick="viewPoint(' +
                          JSON.stringify(feature.geometry.coordinates) +
                          ', \'' + feature.properties.name + '\')">View Point</button>'
                        : ""
                    }</td>`;
            tableBody.appendChild(row);
          });
        })
        .catch((error) => console.error("Error fetching data:", error));

      function viewPolygon(coordinates, title) {
        const geojson = {
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: coordinates,
          },
          properties: {
            title: title
          },
        };
        map.getSource("selected-feature").setData(geojson);
        
        // If popup exists, remove it
        if (popup) {
          popup.remove();
        }

        // Create a new popup
        popup = new mapboxgl.Popup();
        
        // Set the HTML content of the popup
        popup.setLngLat(coordinates[0][0])
          .setHTML('<h3>' + title + '</h3><button onclick="showMoreInfo(\'' + title + '\')">More Info</button>')
          .addTo(map);
      }

      function viewPoint(coordinates, name) {
        const geojson = {
          type: "Feature",
          geometry: {
            type: "Point",
            coordinates: coordinates,
          },
          properties: {
            name: name
          },
        };
        map.getSource("selected-feature").setData(geojson);

        // If popup exists, remove it
        if (popup) {
          popup.remove();
        }

        // Create a new popup
        popup = new mapboxgl.Popup();
        
        // Set the HTML content of the popup
        popup.setLngLat(coordinates)
          .setHTML('<h3>' + name + '</h3><button onclick="showMoreInfo(\'' + name + '\')">More Info</button>')
          .addTo(map);
      }

      function showMoreInfo(title) {
        console.log("Additional info for: " + title);
      }
    </script>
  </body>
</html>
